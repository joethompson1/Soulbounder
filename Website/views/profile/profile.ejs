<head>
	<!-- Stylesheets -->
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
	<link rel="stylesheet" href="/stylesheets/profileStyles/profile.css">
	<link rel="stylesheet" href="/stylesheets/connectWalletStyles/connectWalletButton.css">
	<link rel="stylesheet" href="/stylesheets/viewSBT.css">

	<script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
	<script src="/javascript/walletButton.js"></script>
	<script src="/javascript/profile/profile.js"></script>
	<script src="/javascript/profile/viewAccountSBT.js"></script>
</head>

<body>
	<div class="container__body">
		<div class="container__connectWallet" id="container__connectWallet">
			<div class="container__statusLight" id="container__statusLight">
			</div>
			<p class="text__status" id="text__status">Wallet not connected</p>
		</div>


		<div class="container__mainContents">
			<div class="container__left" id='container__left'>

			</div>
			<div class="container__right" id='container__right'>

			</div>
		</div>
	</div>



	<script type="text/javascript">

		let connectionText, statusLight;

		$(async function() { // execute once the DOM has loaded
			const userWalletAddress = localStorage.getItem('userWalletAddress');

			if (userWalletAddress) {
				setWalletToConnected();
				console.log(userWalletAddress);

				const accountSBT = await loadAccountSBT('<%- contractAbi %>','<%= contractAddress %>', userWalletAddress);

				console.log("accountSBT: ", accountSBT);

				const res = await fetch('/profile/decryptAuthToken', { 
				  method: 'POST', 
				  body: JSON.stringify({ userWalletAddress, SBTData: accountSBT.SBTData}),
				  headers: {'Content-Type': 'application/json'}
				});

				data = await res.json();

				let decrypt = await ethereum.request({
				    method: 'eth_decrypt',
				    params: [data.ct, userWalletAddress],
				 });

				const decryptJson = JSON.parse(decrypt);
				const buffer = new Uint8Array(decryptJson.data);
				const decoder = new TextDecoder('utf-8');
				const SBTData = JSON.parse(decoder.decode(buffer));
			
				viewAccountSBT(SBTData);	
			} 
		});


		$("#container__connectWallet").click(async function(event) {
			const userWalletAddress = await setUserWallet();
			setWalletToConnected(userWalletAddress);

			const accountSBT = await loadAccountSBT('<%- contractAbi %>','<%= contractAddress %>', userWalletAddress);
			
			viewAccountSBT(accountSBT.SBTData);	
		});



		// When the user hovers over container__connectWallet
		$("#container__connectWallet").hover(
		    // If the wallet is not connected, show "Connect Wallet" text and change the status light
		    function() {
		        entersWalletConnect(connectionText);
		    },
		    // When the user stops hovering over the container, show the original text and status light
		    function() {
		        leavesWalletConnect(connectionText, statusLight);
		    }
		);


	</script>

</body>






